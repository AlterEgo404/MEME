<!DOCTYPE html>
<html>
<head>
  <title>Meme App</title>
  <style>
    body { font-family: Arial; }
    #userinfo { margin-top: 10px; }
  </style>
  <style>
  body {
    background: url('2493c60e-fd04-4745-a94c-d03f4db33c0b.png') center/cover no-repeat,
                linear-gradient(135deg, #4e1d7c 30%, #a56ff9 100%);
    font-family: 'Segoe UI', Arial, sans-serif;
    margin: 0;
    padding: 0;
    min-height: 100vh;
    color: #23272f;
  }
  #main-content {
    margin: 40px auto 0 auto;
    background: #fff;
    border-radius: 22px;
    box-shadow: 0 8px 32px 0 rgba(31,38,135,0.18);
    max-width: 530px;
    padding: 32px 34px 24px 34px;
    text-align: center;
  }
  #main-content h3 {
    font-weight: 700;
    letter-spacing: 0.5px;
    margin-top: 18px;
    margin-bottom: 14px;
    color: #6c36ad;
  }
  #main-content input, #main-content select {
    padding: 7px 13px;
    border-radius: 8px;
    border: 1px solid #ccd9ea;
    font-size: 15px;
    background: #f7f9fe;
    margin-bottom: 6px;
    margin-right: 4px;
  }
  #main-content button {
    background: linear-gradient(90deg, #4f8cff, #39cbe3 80%);
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 7px 17px;
    font-size: 15px;
    margin: 5px 6px 7px 0;
    cursor: pointer;
    box-shadow: 0 2px 8px #b6d2ff22;
    transition: background 0.15s, transform 0.12s;
  }
  #main-content button:hover {
    background: linear-gradient(90deg, #3489f1, #30adc3 80%);
    transform: translateY(-2px) scale(1.04);
  }

  #discordinfo, #userinfo {
    margin: 25px auto 10px auto;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 12px #2b304040;
    padding: 16px 28px 16px 28px;
    width: 98%;
    max-width: 420px;
    text-align: left;
  }
  #userinfo img, #discordinfo img {
    border-radius: 50%;
    border: 2.5px solid #4f8cff;
    margin-right: 14px;
    vertical-align: middle;
    background: #f8fafc;
  }
  #login-box {
    margin: 80px auto 0 auto;
    background: rgba(255,255,255,0.08);
    border-radius: 24px;
    box-shadow: 0 8px 32px 0 rgba(31,38,135,0.28);
    backdrop-filter: blur(13px);
    -webkit-backdrop-filter: blur(13px);
    border: 1.7px solid rgba(255,255,255,0.21);
    padding: 38px 44px 28px 44px;
    max-width: 350px;
    text-align: center;
  }
  #login-box h2 {
    color: #fff;
    font-size: 2.1rem;
    font-weight: 700;
    margin-bottom: 22px;
    text-shadow: 0 1px 10px #0001;
    letter-spacing: 1px;
  }
  #login-box input[type="text"], 
  #login-box input[type="password"] {
    border: none;
    border-radius: 12px;
    padding: 14px 16px;
    font-size: 17px;
    margin-bottom: 16px;
    width: 100%;
    box-sizing: border-box;
    background: rgba(255,255,255,0.18);
    color: #fff;
    font-weight: 500;
    outline: none;
    transition: background 0.19s;
  }
  #login-box input::placeholder {
    color: #dad9ec;
    font-size: 0.98rem;
    font-weight: 500;
    letter-spacing: 0.2px;
  }
  #login-box button {
    width: 100%;
    padding: 13px 0;
    border-radius: 22px;
    font-size: 1.13rem;
    background: linear-gradient(90deg, #9c70f9, #65d7fa 90%);
    margin: 14px 0 8px 0;
    font-weight: 600;
    box-shadow: 0 4px 20px #a675fc35;
  }
  #login-box button:hover {
    background: linear-gradient(90deg, #8c56e9, #37b5ee 90%);
    transform: scale(1.04);
  }
  #login-box .register-link {
    color: #f5f2ff;
    font-size: 1.01rem;
    margin-top: 16px;
    text-shadow: 0 1px 8px #2d014c22;
  }
  #login-box .register-link a {
    color: #60dcff;
    text-decoration: underline;
    font-weight: 600;
    transition: color 0.12s;
  }
  #login-box .register-link a:hover { color: #fff }
  button {
    background: linear-gradient(90deg, #4f8cff, #39cbe3 80%);
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 8px 18px;
    font-size: 15px;
    margin: 5px 6px 7px 0;
    cursor: pointer;
    box-shadow: 0 2px 8px #b6d2ff22;
    transition: background 0.15s, transform 0.12s;
  }
  button:hover {
    background: linear-gradient(90deg, #3489f1, #30adc3 80%);
    transform: translateY(-2px) scale(1.04);
  }
  #functions {
    margin: 10px auto;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 12px #2b304040;
    padding: 22px 30px;
    max-width: 430px;
    text-align: center;
  }
  #msg {
    margin: 14px auto;
    color: #d8214a;
    font-weight: 500;
    text-align: center;
  }
  ul, li {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  ul {
    margin: 7px 0 18px 0;
  }
  li {
    background: #f3f8ff;
    border-radius: 8px;
    margin-bottom: 6px;
    padding: 7px 13px;
    font-size: 15px;
    color: #295079;
  }
  h1, h3 {
    text-align: center;
    font-weight: 700;
    letter-spacing: 1px;
    color: #2d3a5c;
    margin-top: 16px;
  }
  input[type="number"], select {
    padding: 7px 13px;
    border-radius: 8px;
    border: 1px solid #ccd9ea;
    font-size: 15px;
    background: #f8fafc;
    margin-bottom: 6px;
  }
  #cccdimg {
    display: block;
    margin: 22px auto 10px auto;
    border-radius: 16px;
    box-shadow: 0 4px 18px #b2bbdd44;
    max-width: 410px;
  }
  #taixiu-box, #hunt-box {
    background: #f6faff;
    border-radius: 16px;
    box-shadow: 0 2px 8px #a69efc13;
    padding: 18px 24px;
    max-width: 420px;
    margin: 0 auto 24px auto;
    text-align: left;
  }
  #taixiu-box h3, #hunt-box h3 {
    color: #6c36ad;
    margin-bottom: 12px;
    margin-top: 0;
    font-size: 1.1rem;
  }
  @media (max-width: 600px) {
    #login-box, #functions, #discordinfo, #userinfo {
      max-width: 98vw;
      padding: 10vw 2vw;
    }
    h1 { font-size: 22px; }
  }
  </style>
</head>
<body>
  <h1>Meme App</h1>
  
  <!-- ƒêƒÉng nh·∫≠p/ƒêƒÉng k√Ω -->
  <div id="login-box">
    <h2>Login</h2>
    <button onclick="window.location='/login/discord'">ƒêƒÉng nh·∫≠p b·∫±ng Discord</button>
  </div>

  <!-- MAIN CONTENT, ch·ªâ hi·ªán khi ƒëƒÉng nh·∫≠p -->
  <div id="main-content">
    <!-- D√£y n√∫t ch·ª©c nƒÉng -->
    <div id="functions">
      <button onclick="daily()">Nh·∫≠n qu√† Daily</button>
      <button onclick="getShop()">Xem Shop</button>
      <button onclick="showJar()">Xem h≈© Jackpot</button>
      <button onclick="showCCCD()">Xem ·∫£nh CCCD</button>
      <button onclick="showLeaderboard()">Xem b·∫£ng x·∫øp h·∫°ng</button>
      <button onclick="study()">H·ªçc tƒÉng tr√¨nh ƒë·ªô</button>
      <button onclick="showTaixiu()">T√†i x·ªâu</button>
      <button onclick="showHunt()">ƒêi sƒÉn</button>
      <button onclick="logout()">ƒêƒÉng xu·∫•t</button>
    </div>
    <div id="userinfo"></div>
    <div id="content-box"></div>
  </div>

    <!-- Th√¥ng tin t√†i kho·∫£n -->
    <div id="userinfo"></div>
    <ul id="shopinfo"></ul>
    <ul id="lbinfo"></ul>
    <p id="jackpot"></p>
  </div>
  <!-- ·∫¢nh CCCD -->
  <img id="cccdimg" width="400" style="margin:22px auto 10px auto; display:block;">
  <script>
  function hunt() {
    let uid = getUID();
    let weapon = document.getElementById("hunt_weapon").value;
    fetch('/api/hunt', {
      method: 'POST',
      body: JSON.stringify({ user_id: uid, weapon: weapon }),
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      let box = document.getElementById("huntresult");
      box.innerText = data.msg;
      getUserInfo();
    });
  }
  </script>
  <script>

    // C√≥ th·ªÉ l·∫•y info t·ª´ localStorage ƒë·ªÉ auto ƒëƒÉng nh·∫≠p m·ªçi l·∫ßn sau
    window.onload = function() {
      let uid = localStorage.getItem('uid');
      if(uid) {
        setUser(uid);
        document.getElementById("login-box").style.display = "none";
        document.getElementById("main-content").style.display = "";
      } else {
        document.getElementById("login-box").style.display = "";
        document.getElementById("main-content").style.display = "none";
      }
    }
  </script>
  <p id="msg"></p>
  <script>

    // ƒêƒÉng k√Ω t√†i kho·∫£n
    function register() {
      var uid = document.getElementById("uid").value;
      if (!uid) return alert('Vui l√≤ng nh·∫≠p user_id!');
      fetch('/api/start', {
        method: 'POST',
        body: JSON.stringify({ user_id: uid }),
        headers: { 'Content-Type': 'application/json' }
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById("msg").innerText = data.msg;
        if (data.success) {
          setUser(uid);
        }
      });
    }

    // ƒêƒÉng nh·∫≠p (ch·ªâ ki·ªÉm tra c√≥ t·ªìn t·∫°i user_id)
    function login() {
      var uid = document.getElementById("uid").value;
      if (!uid) return alert('Vui l√≤ng nh·∫≠p user_id!');
      fetch('/api/user/' + uid)
      .then(res => res.json())
      .then(user => {
        if (user.success) {
          document.getElementById("msg").innerText = "ƒêƒÉng nh·∫≠p th√†nh c√¥ng!";
          setUser(uid);
        } else {
          document.getElementById("msg").innerText = "Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n. H√£y ƒëƒÉng k√Ω tr∆∞·ªõc.";
        }
      });
    }

    // Thi·∫øt l·∫≠p session
    function setUser(uid) {
      localStorage.setItem('uid', uid);
      document.getElementById('login-box').style.display = 'none';
      document.getElementById('main-content').style.display = '';
      getUserInfo();
      document.getElementById("shopinfo").innerHTML = "";
      document.getElementById("msg").innerText = "";
      // Hi·ªán lu√¥n avatar v√† t√™n Discord
      let avatar = localStorage.getItem('avatar');
      let username = localStorage.getItem('username');
      if (avatar && username) {
        document.getElementById("userinfo").innerHTML =
          `<img src="${avatar}" width="50" style="border-radius:50%;vertical-align:middle"> 
          <b>${username}</b> (Discord ID: ${uid})`;
      }
    }

    // ƒêƒÉng xu·∫•t
    function logout() {
      localStorage.removeItem('uid');
      localStorage.removeItem('avatar');
      localStorage.removeItem('username');
      document.getElementById('login-box').style.display = '';
      document.getElementById('main-content').style.display = 'none';
      document.getElementById('userinfo').innerHTML = '';
      document.getElementById('shopinfo').innerHTML = '';
    }

    // L·∫•y uid hi·ªán t·∫°i
    function getUID() {
      return localStorage.getItem('uid');
    }

    // Hi·ªán th√¥ng tin user
    function getUserInfo() {
      let uid = getUID();
      let avatar = localStorage.getItem('avatar');
      let username = localStorage.getItem('username');
      if (!uid) return;
      fetch('/api/user/' + uid)
      .then(res => res.json())
      .then(user => {
        if(user.success){
          let html = "";
          
          // Hi·ªán avatar + username Discord
          if (avatar && username) {
            html += `<img src="${avatar}" width="50" style="border-radius:50%;vertical-align:middle"> <b>${username}</b> (Discord ID: ${uid})<br>`;
          }
          html += "<b>Th√¥ng tin t√†i kho·∫£n:</b><br>";
          html += "ƒêi·ªÉm: " + user.points + "<br>";
          html += "Smart: " + user.smart + "<br>";
          html += "Items: ";
          if (Object.keys(user.items).length > 0) {
            html += "<ul>";
            for(let key in user.items) {
              html += "<li>" + key + ": " + user.items[key] + "</li>";
            }
            html += "</ul>";
          } else {
            html += " (Tr·ªëng)";
          }
          document.getElementById("userinfo").innerHTML = html;
        }
      });
    }

    // Nh·∫≠n qu√† daily
    function daily() {
      let uid = getUID();
      fetch('/api/daily', {
        method: 'POST',
        body: JSON.stringify({ user_id: uid }),
        headers: { 'Content-Type': 'application/json' }
      })
        .then(res => res.json())
        .then(data => {
          document.getElementById("content-box").innerHTML = `<div>${data.msg}</div>`;
          if (data.success) getUserInfo();
        });
    }

    // Hi·ªán shop, cho ph√©p v·ª´a mua v·ª´a b√°n
    function getShop() {
      let uid = getUID();
      fetch('/api/user/' + uid)
        .then(res => res.json())
        .then(user => {
          if (!user.success) return;
          let userItems = user.items || {};
          fetch('/api/shop')
            .then(res => res.json())
            .then(data => {
              let html = "<ul>";
              for (let id in data.shop) {
                let sp = data.shop[id];
                let own = userItems[sp.name] || 0;
                html += `<li>
                  ${sp.name} - Gi√°: ${sp.price} 
                  <button onclick="buyItem('${id}')">Mua</button>
                  ${own > 0 ? `
                    <button onclick="sellItemPrompt('${id}', '${sp.name}', ${own})">B√°n</button>
                    (B·∫°n c√≥: ${own})
                  ` : ""}
                </li>`;
              }
              html += "</ul>";
              document.getElementById("content-box").innerHTML = html;
            });
        });
    }

    // Mua item trong shop
    function buyItem(id) {
      let uid = getUID();
      let sl = prompt("Nh·∫≠p s·ªë l∆∞·ª£ng mu·ªën mua:", 1);
      if (!sl || isNaN(sl) || Number(sl) < 1) return;
      fetch('/api/buy', {
        method: 'POST',
        body: JSON.stringify({ user_id: uid, item_id: id, quantity: Number(sl) }),
        headers: { 'Content-Type': 'application/json' }
      })
      .then(res => res.json())
      .then(data => {
        alert(data.msg);
        getUserInfo();
        getShop(); // c·∫≠p nh·∫≠t l·∫°i shop cho ch√≠nh x√°c s·ªë l∆∞·ª£ng
      });
    }

    // B√°n item trong shop (s·ª≠ d·ª•ng prompt ƒë·ªÉ nh·∫≠p s·ªë l∆∞·ª£ng)
    function sellItemPrompt(item_id, item_name, maxQty) {
      let uid = getUID();
      let sl = prompt(`Nh·∫≠p s·ªë l∆∞·ª£ng mu·ªën b√°n (B·∫°n c√≥: ${maxQty}):`, 1);
      if (!sl || isNaN(sl) || Number(sl) < 1) return;
      if (Number(sl) > maxQty) return alert("B·∫°n kh√¥ng c√≥ ƒë·ªß v·∫≠t ph·∫©m ƒë·ªÉ b√°n!");
      fetch('/api/sell', {
        method: 'POST',
        body: JSON.stringify({ user_id: uid, item_id: item_id, quantity: Number(sl) }),
        headers: { 'Content-Type': 'application/json' }
      })
      .then(res => res.json())
      .then(data => {
        alert(data.msg);
        getUserInfo();
        getShop(); // c·∫≠p nh·∫≠t l·∫°i shop cho ch√≠nh x√°c s·ªë l∆∞·ª£ng
      });
    }
  </script>
  <p id="jackpot"></p>
  <script>
  function showJar() {
    fetch('/api/jar')
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById("content-box").innerHTML =
            `<p style="font-size:20px; color:#c88c0c;">üí∞ Jackpot hi·ªán t·∫°i: <b>${data.jackpot_fmt} coin</b></p>`;
        }
      });
  }
  </script>
  <br>
  <img id="cccdimg" width="400" style="margin-top:10px;">
  <script>
  function showCCCD() {
    let uid = getUID();
    let avatar = localStorage.getItem('avatar');
    let username = localStorage.getItem('username');
    let url = '/api/cccd/' + uid +
      '?avatar=' + encodeURIComponent(avatar) +
      '&username=' + encodeURIComponent(username) +
      '&rand=' + Math.random();
    document.getElementById("content-box").innerHTML =
      `<img id="cccdimg" width="400" style="margin:22px auto 10px auto; display:block;" src="${url}">`;
  }
  </script>
  <script>
  function showLeaderboard() {
    fetch('/api/leaderboard/a')
      .then(res => res.json())
      .then(data => {
        let html = "<ul>";
        for (let u of data.leaderboard) {
          html += `<li>User: ${u.user_id} ‚Äì ƒêi·ªÉm: ${u.value}</li>`;
        }
        html += "</ul>";
        document.getElementById("content-box").innerHTML = html;
      });
  }
  </script>
  <script>
  function study() {
    let uid = getUID();
    fetch('/api/study', {
      method: 'POST',
      body: JSON.stringify({ user_id: uid }),
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      alert(data.msg);
      getUserInfo();
    });
  }
  </script>
  <script>
  function showTaixiu() {
    document.getElementById("content-box").innerHTML = `
      <div id="taixiu-box">
        <h3>Ch∆°i t√†i x·ªâu</h3>
        <input type="number" id="ou_bet" placeholder="S·ªë ƒëi·ªÉm c∆∞·ª£c" min="1" style="width:120px;">
        <select id="ou_choice">
          <option value="t">T√†i</option>
          <option value="x">X·ªâu</option>
        </select>
        <button onclick="playOu()">Ch∆°i</button>
        <div id="ouresult" style="margin-top:10px;"></div>
      </div>
    `;
  }
  function playOu() {
    let uid = getUID();
    let bet = document.getElementById("ou_bet").value;
    let choice = document.getElementById("ou_choice").value;
    if (!bet || !choice) return alert("ƒêi·ªÅn ƒë·ªß ƒëi·ªÉm c∆∞·ª£c v√† ch·ªçn T√†i/X·ªâu!");
    fetch('/api/ou', {
      method: 'POST',
      body: JSON.stringify({ user_id: uid, bet: bet, choice: choice }),
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      let resBox = document.getElementById("ouresult");
      if (!data.success) {
        resBox.innerText = data.msg;
      } else {
        resBox.innerHTML = `<b>${data.win ? "üéâ Th·∫Øng!" : "üíÄ Thua!"}</b><br>
          K·∫øt qu·∫£: ${data.dice[0]}, ${data.dice[1]}, ${data.dice[2]} (T·ªïng: ${data.total})<br>
          ${data.msg}`;
        getUserInfo();
      }
    });
  }
  </script>
  <script>
  function showHunt() {
    document.getElementById("content-box").innerHTML = `
      <div id="hunt-box">
        <h3>ƒêi sƒÉn</h3>
        <select id="hunt_weapon">
          <option value="g">S√∫ng sƒÉn</option>
          <option value="a">Awm</option>
          <option value="r">RPG</option>
          <option value="c">M√°y h√∫t b·ª•i</option>
        </select>
        <button onclick="hunt()">SƒÉn</button>
        <div id="huntresult" style="margin-top:10px;"></div>
      </div>
    `;
  }
  function hunt() {
    let uid = getUID();
    let weapon = document.getElementById("hunt_weapon").value;
    fetch('/api/hunt', {
      method: 'POST',
      body: JSON.stringify({ user_id: uid, weapon: weapon }),
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      let box = document.getElementById("huntresult");
      box.innerText = data.msg;
      getUserInfo();
    });
  }
  </script>
</body>
</html>