<!DOCTYPE html>
<html>
<head>
  <title>Meme App</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <h1>Meme App</h1>
  
  <!-- ƒêƒÉng nh·∫≠p/ƒêƒÉng k√Ω -->
  <div id="login-box">
    <h2>Login</h2>
    <button onclick="window.location='/login/discord'">ƒêƒÉng nh·∫≠p b·∫±ng Discord</button>
  </div>

  <!-- MAIN CONTENT, ch·ªâ hi·ªán khi ƒëƒÉng nh·∫≠p -->
  <div id="main-content">
    <!-- D√£y n√∫t ch·ª©c nƒÉng -->
    <div id="functions">
      <button onclick="daily()">Nh·∫≠n qu√† Daily</button>
      <button onclick="getShop()">Xem Shop</button>
      <button onclick="showJar()">Xem h≈© Jackpot</button>
      <button onclick="showCCCD()">Xem ·∫£nh CCCD</button>
      <button onclick="showLeaderboard()">Xem b·∫£ng x·∫øp h·∫°ng</button>
      <button onclick="study()">H·ªçc tƒÉng tr√¨nh ƒë·ªô</button>
      <button onclick="showTaixiu()">T√†i x·ªâu</button>
      <button onclick="showHunt()">ƒêi sƒÉn</button>
      <button onclick="logout()">ƒêƒÉng xu·∫•t</button>
    </div>
    <div id="userinfo"></div>
    <div id="content-box"></div>
  </div>

    <!-- Th√¥ng tin t√†i kho·∫£n -->
    <div id="userinfo"></div>
    <ul id="shopinfo"></ul>
    <ul id="lbinfo"></ul>
    <p id="jackpot"></p>
  </div>
  <!-- ·∫¢nh CCCD -->
  <img id="cccdimg" width="400" style="margin:22px auto 10px auto; display:block;">
  <script>
  function hunt() {
    let uid = getUID();
    let weapon = document.getElementById("hunt_weapon").value;
    fetch('/api/hunt', {
      method: 'POST',
      body: JSON.stringify({ user_id: uid, weapon: weapon }),
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      let box = document.getElementById("huntresult");
      box.innerText = data.msg;
      getUserInfo();
    });
  }
  </script>
  <script>

    // C√≥ th·ªÉ l·∫•y info t·ª´ localStorage ƒë·ªÉ auto ƒëƒÉng nh·∫≠p m·ªçi l·∫ßn sau
    window.onload = function() {
      let uid = localStorage.getItem('uid');
      if(uid) {
        setUser(uid);
        document.getElementById("login-box").style.display = "none";
        document.getElementById("main-content").style.display = "";
      } else {
        document.getElementById("login-box").style.display = "";
        document.getElementById("main-content").style.display = "none";
      }
    }
  </script>
  <p id="msg"></p>
  <script>

    // ƒêƒÉng k√Ω t√†i kho·∫£n
    function register() {
      var uid = document.getElementById("uid").value;
      if (!uid) return alert('Vui l√≤ng nh·∫≠p user_id!');
      fetch('/api/start', {
        method: 'POST',
        body: JSON.stringify({ user_id: uid }),
        headers: { 'Content-Type': 'application/json' }
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById("msg").innerText = data.msg;
        if (data.success) {
          setUser(uid);
        }
      });
    }

    // ƒêƒÉng nh·∫≠p (ch·ªâ ki·ªÉm tra c√≥ t·ªìn t·∫°i user_id)
    function login() {
      var uid = document.getElementById("uid").value;
      if (!uid) return alert('Vui l√≤ng nh·∫≠p user_id!');
      fetch('/api/user/' + uid)
      .then(res => res.json())
      .then(user => {
        if (user.success) {
          document.getElementById("msg").innerText = "ƒêƒÉng nh·∫≠p th√†nh c√¥ng!";
          setUser(uid);
        } else {
          document.getElementById("msg").innerText = "Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n. H√£y ƒëƒÉng k√Ω tr∆∞·ªõc.";
        }
      });
    }

    // Thi·∫øt l·∫≠p session
    function setUser(uid) {
      localStorage.setItem('uid', uid);
      document.getElementById('login-box').style.display = 'none';
      document.getElementById('main-content').style.display = '';
      getUserInfo();
      document.getElementById("shopinfo").innerHTML = "";
      document.getElementById("msg").innerText = "";
      // Hi·ªán lu√¥n avatar v√† t√™n Discord
      let avatar = localStorage.getItem('avatar');
      let username = localStorage.getItem('username');
      if (avatar && username) {
        document.getElementById("userinfo").innerHTML =
          `<img src="${avatar}" width="50" style="border-radius:50%;vertical-align:middle"> 
          <b>${username}</b> (Discord ID: ${uid})`;
      }
    }

    // ƒêƒÉng xu·∫•t
    function logout() {
      localStorage.removeItem('uid');
      localStorage.removeItem('avatar');
      localStorage.removeItem('username');
      document.getElementById('login-box').style.display = '';
      document.getElementById('main-content').style.display = 'none';
      document.getElementById('userinfo').innerHTML = '';
      document.getElementById('shopinfo').innerHTML = '';
    }

    // L·∫•y uid hi·ªán t·∫°i
    function getUID() {
      return localStorage.getItem('uid');
    }

    // Hi·ªán th√¥ng tin user
    function getUserInfo() {
      let uid = getUID();
      let avatar = localStorage.getItem('avatar');
      let username = localStorage.getItem('username');
      if (!uid) return;
      fetch('/api/user/' + uid)
      .then(res => res.json())
      .then(user => {
        if(user.success){
          let html = "";
          
          // Hi·ªán avatar + username Discord
          if (avatar && username) {
            html += `<img src="${avatar}" width="50" style="border-radius:50%;vertical-align:middle"> <b>${username}</b> (Discord ID: ${uid})<br>`;
          }
          html += "<b>Th√¥ng tin t√†i kho·∫£n:</b><br>";
          html += "ƒêi·ªÉm: " + user.points + "<br>";
          html += "Smart: " + user.smart + "<br>";
          html += "Items: ";
          if (Object.keys(user.items).length > 0) {
            html += "<ul>";
            for(let key in user.items) {
              html += "<li>" + key + ": " + user.items[key] + "</li>";
            }
            html += "</ul>";
          } else {
            html += " (Tr·ªëng)";
          }
          document.getElementById("userinfo").innerHTML = html;
        }
      });
    }

    // Nh·∫≠n qu√† daily
    function daily() {
      let uid = getUID();
      fetch('/api/daily', {
        method: 'POST',
        body: JSON.stringify({ user_id: uid }),
        headers: { 'Content-Type': 'application/json' }
      })
        .then(res => res.json())
        .then(data => {
          document.getElementById("content-box").innerHTML = `<div>${data.msg}</div>`;
          if (data.success) getUserInfo();
        });
    }

    // Hi·ªán shop, cho ph√©p v·ª´a mua v·ª´a b√°n
    function getShop() {
      let uid = getUID();
      fetch('/api/user/' + uid)
        .then(res => res.json())
        .then(user => {
          if (!user.success) return;
          let userItems = user.items || {};
          fetch('/api/shop')
            .then(res => res.json())
            .then(data => {
              let html = "<ul>";
              for (let id in data.shop) {
                let sp = data.shop[id];
                let own = userItems[sp.name] || 0;
                html += `<li>
                  ${sp.name} - Gi√°: ${sp.price} 
                  <button onclick="buyItem('${id}')">Mua</button>
                  ${own > 0 ? `
                    <button onclick="sellItemPrompt('${id}', '${sp.name}', ${own})">B√°n</button>
                    (B·∫°n c√≥: ${own})
                  ` : ""}
                </li>`;
              }
              html += "</ul>";
              document.getElementById("content-box").innerHTML = html;
            });
        });
    }

    // Mua item trong shop
    function buyItem(id) {
      let uid = getUID();
      let sl = prompt("Nh·∫≠p s·ªë l∆∞·ª£ng mu·ªën mua:", 1);
      if (!sl || isNaN(sl) || Number(sl) < 1) return;
      fetch('/api/buy', {
        method: 'POST',
        body: JSON.stringify({ user_id: uid, item_id: id, quantity: Number(sl) }),
        headers: { 'Content-Type': 'application/json' }
      })
      .then(res => res.json())
      .then(data => {
        alert(data.msg);
        getUserInfo();
        getShop(); // c·∫≠p nh·∫≠t l·∫°i shop cho ch√≠nh x√°c s·ªë l∆∞·ª£ng
      });
    }

    // B√°n item trong shop (s·ª≠ d·ª•ng prompt ƒë·ªÉ nh·∫≠p s·ªë l∆∞·ª£ng)
    function sellItemPrompt(item_id, item_name, maxQty) {
      let uid = getUID();
      let sl = prompt(`Nh·∫≠p s·ªë l∆∞·ª£ng mu·ªën b√°n (B·∫°n c√≥: ${maxQty}):`, 1);
      if (!sl || isNaN(sl) || Number(sl) < 1) return;
      if (Number(sl) > maxQty) return alert("B·∫°n kh√¥ng c√≥ ƒë·ªß v·∫≠t ph·∫©m ƒë·ªÉ b√°n!");
      fetch('/api/sell', {
        method: 'POST',
        body: JSON.stringify({ user_id: uid, item_id: item_id, quantity: Number(sl) }),
        headers: { 'Content-Type': 'application/json' }
      })
      .then(res => res.json())
      .then(data => {
        alert(data.msg);
        getUserInfo();
        getShop(); // c·∫≠p nh·∫≠t l·∫°i shop cho ch√≠nh x√°c s·ªë l∆∞·ª£ng
      });
    }
  </script>
  <p id="jackpot"></p>
  <script>
  function showJar() {
    fetch('/api/jar')
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById("content-box").innerHTML =
            `<p style="font-size:20px; color:#c88c0c;">üí∞ Jackpot hi·ªán t·∫°i: <b>${data.jackpot_fmt} coin</b></p>`;
        }
      });
  }
  </script>
  <br>
  <img id="cccdimg" width="400" style="margin-top:10px;">
  <script>
  function showCCCD() {
    let uid = getUID();
    let avatar = localStorage.getItem('avatar');
    let username = localStorage.getItem('username');
    let url = '/api/cccd/' + uid +
      '?avatar=' + encodeURIComponent(avatar) +
      '&username=' + encodeURIComponent(username) +
      '&rand=' + Math.random();
    document.getElementById("content-box").innerHTML =
      `<img id="cccdimg" width="400" style="margin:22px auto 10px auto; display:block;" src="${url}">`;
  }
  </script>
  <script>
  function showLeaderboard() {
    fetch('/api/leaderboard/a')
      .then(res => res.json())
      .then(data => {
        let html = "<ul>";
        for (let u of data.leaderboard) {
          html += `<li>User: ${u.user_id} ‚Äì ƒêi·ªÉm: ${u.value}</li>`;
        }
        html += "</ul>";
        document.getElementById("content-box").innerHTML = html;
      });
  }
  </script>
  <script>
  function study() {
    let uid = getUID();
    fetch('/api/study', {
      method: 'POST',
      body: JSON.stringify({ user_id: uid }),
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      alert(data.msg);
      getUserInfo();
    });
  }
  </script>
  <script>
  function showTaixiu() {
    document.getElementById("content-box").innerHTML = `
      <div id="taixiu-box">
        <input type="number" id="ou_bet" placeholder="S·ªë ti·ªÅn c∆∞·ª£c" style="margin-bottom: 12px; width: 160px;"><br>
        <button onclick="playOu('t')">T√†i</button>
        <button onclick="playOu('x')">X·ªâu</button>
        <div id="ouresult" style="margin-top:14px;"></div>
      </div>
    `;
  }
  function playOu(choice) {
    let uid = getUID();
    let bet = document.getElementById("ou_bet").value;
    if (!bet) return alert("B·∫°n c·∫ßn nh·∫≠p s·ªë ti·ªÅn c∆∞·ª£c!");
    fetch('/api/ou', {
      method: 'POST',
      body: JSON.stringify({ user_id: uid, bet: bet, choice: choice }),
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      let resBox = document.getElementById("ouresult");
      if (!data.success) {
        resBox.innerText = data.msg;
      } else {
        resBox.innerHTML = `<b>${data.win ? "üéâ Th·∫Øng!" : "üíÄ Thua!"}</b><br>
          K·∫øt qu·∫£: ${data.dice[0]}, ${data.dice[1]}, ${data.dice[2]} (T·ªïng: ${data.total})<br>
          ${data.msg}`;
        getUserInfo();
      }
    });
  }
  </script>
  <script>
  function showHunt() {
    document.getElementById("content-box").innerHTML = `
      <div id="hunt-box">
        <h3>ƒêi sƒÉn</h3>
        <select id="hunt_weapon">
          <option value="g">S√∫ng sƒÉn</option>
          <option value="a">Awm</option>
          <option value="r">RPG</option>
          <option value="c">M√°y h√∫t b·ª•i</option>
        </select>
        <button onclick="hunt()">SƒÉn</button>
        <div id="huntresult" style="margin-top:10px;"></div>
      </div>
    `;
  }
  function hunt() {
    let uid = getUID();
    let weapon = document.getElementById("hunt_weapon").value;
    fetch('/api/hunt', {
      method: 'POST',
      body: JSON.stringify({ user_id: uid, weapon: weapon }),
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      let box = document.getElementById("huntresult");
      box.innerText = data.msg;
      getUserInfo();
    });
  }
  </script>
</body>
</html>