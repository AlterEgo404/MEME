<!DOCTYPE html>
<html>
<head>
  <title>Meme App</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <h1>Meme App</h1>
  <!-- LOGIN BOX -->
  <div id="login-box">
    <h2>ƒêƒÉng nh·∫≠p ho·∫∑c ƒêƒÉng k√Ω</h2>
    <div id="tabs">
      <button onclick="showTab('login-email')">Email</button>
      <button onclick="showTab('register')">ƒêƒÉng k√Ω</button>
      <button onclick="showTab('discord')">Discord</button>
    </div>
    <div id="login-email" class="tab-content">
      <input type="text" id="login_user" placeholder="User ID ho·∫∑c Email"><br>
      <input type="password" id="login_pass" placeholder="M·∫≠t kh·∫©u"><br>
      <button onclick="loginEmail()">ƒêƒÉng nh·∫≠p b·∫±ng Email</button>
    </div>
    <div id="register" class="tab-content" style="display:none;">
      <input type="text" id="reg_user" placeholder="User ID"><br>
      <input type="text" id="reg_email" placeholder="Email"><br>
      <input type="password" id="reg_pass" placeholder="M·∫≠t kh·∫©u"><br>
      <button onclick="registerEmail()">ƒêƒÉng k√Ω t√†i kho·∫£n</button>
    </div>
    <div id="discord" class="tab-content" style="display:none;">
      <button onclick="window.location='/login/discord'">ƒêƒÉng nh·∫≠p b·∫±ng Discord</button>
    </div>
    <p id="msg"></p>
  </div>
  <!-- MAIN CONTENT, ch·ªâ hi·ªán khi ƒëƒÉng nh·∫≠p -->
  <script>
    function switchTab(tab) {
        document.querySelectorAll('.ribbon-tab').forEach((t, i) => {
            t.classList.toggle('active', (tab === 'games' && i === 0) || (tab === 'chat' && i === 1));
        });
        document.getElementById('games-tab').style.display = tab === 'games' ? '' : 'none';
        document.getElementById('chat-tab').style.display = tab === 'chat' ? '' : 'none';
    }

    // Chat ƒë∆°n gi·∫£n (client-only, ch∆∞a l∆∞u DB)
    function sendChat() {
        let chatWindow = document.getElementById('chat-window');
        let input = document.getElementById('chat-input');
        let text = input.value.trim();
        if (!text) return;
        let div = document.createElement('div');
        div.style.margin = '5px 0';
        div.innerHTML = '<b>B·∫°n:</b> ' + text;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        input.value = '';
        // N·∫øu mu·ªën g·ª≠i l√™n backend, b·∫°n th√™m fetch('/api/chat', { ... })
    }
  </script>
  <div class="ribbon-menu">
      <span class="ribbon-tab active" onclick="switchTab('games')">Tr√≤ ch∆°i</span>
      <span class="ribbon-tab" onclick="switchTab('chat')">Tr√≤ chuy·ªán</span>
  </div>
  <div id="games-tab" class="tab-content">
    <div id="main-content" style="display:none;">
      <div id="functions">
        <button onclick="daily()">Nh·∫≠n qu√† Daily</button>
        <button onclick="getShop()">Xem Shop</button>
        <button onclick="showJar()">Xem h≈© Jackpot</button>
        <button onclick="showCCCD()">Xem ·∫£nh CCCD</button>
        <button onclick="showLeaderboard()">Xem b·∫£ng x·∫øp h·∫°ng</button>
        <button onclick="study()">H·ªçc tƒÉng tr√¨nh ƒë·ªô</button>
        <button onclick="showTaixiu()">T√†i x·ªâu</button>
        <button onclick="showHunt()">ƒêi sƒÉn</button>
        <button onclick="logout()">ƒêƒÉng xu·∫•t</button>
        <button onclick="linkDiscord()" id="link-discord-btn" style="display:none;">Li√™n k·∫øt Discord</button>
      </div>
      <div id="userinfo"></div>
      <div id="content-box"></div>
    </div>
    <script>
      // Hi·ªÉn th·ªã tab login/register/discord
      function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.getElementById(tabId).style.display = '';
      }

      // Auto ƒëƒÉng nh·∫≠p n·∫øu ƒë√£ l∆∞u
      window.onload = function() {
        let uid = localStorage.getItem('uid');
        if(uid) {
          setUser(uid);
          document.getElementById("login-box").style.display = "none";
          document.getElementById("main-content").style.display = "";
        } else {
          document.getElementById("login-box").style.display = "";
          document.getElementById("main-content").style.display = "none";
        }
      }

      // ƒêƒÉng nh·∫≠p b·∫±ng email/user
      function loginEmail() {
        var user = document.getElementById("login_user").value;
        var pass = document.getElementById("login_pass").value;
        if (!user || !pass) return alert("ƒêi·ªÅn ƒë·ªß th√¥ng tin!");
        fetch('/api/login', {
          method: 'POST',
          body: JSON.stringify({user_id: user, password: pass}),
          headers: {'Content-Type': 'application/json'}
        }).then(r => r.json()).then(data => {
          document.getElementById("msg").innerText = data.msg;
          if (data.success) {
            setUser(user);
          }
        });
      }

      // ƒêƒÉng k√Ω t√†i kho·∫£n email
      function registerEmail() {
        var user = document.getElementById("reg_user").value;
        var email = document.getElementById("reg_email").value;
        var pass = document.getElementById("reg_pass").value;
        if (!user || !email || !pass) return alert("ƒêi·ªÅn ƒë·ªß th√¥ng tin!");
        fetch('/api/register', {
          method: 'POST',
          body: JSON.stringify({user_id: user, email: email, password: pass}),
          headers: {'Content-Type': 'application/json'}
        }).then(r => r.json()).then(data => {
          document.getElementById("msg").innerText = data.msg;
        });
      }

      // Thi·∫øt l·∫≠p user sau khi login th√†nh c√¥ng
      function setUser(uid) {
        localStorage.setItem('uid', uid);
        document.getElementById('login-box').style.display = 'none';
        document.getElementById('main-content').style.display = '';
        getUserInfo();
        fetch('/api/user/' + uid)
          .then(res => res.json())
          .then(user => {
            if (user.success && !user.discord_id) {
              document.getElementById("link-discord-btn").style.display = '';
            } else {
              document.getElementById("link-discord-btn").style.display = 'none';
            }
          });
      }

      // ƒêƒÉng xu·∫•t
      function logout() {
        localStorage.clear();
        document.getElementById('login-box').style.display = '';
        document.getElementById('main-content').style.display = 'none';
        document.getElementById('userinfo').innerHTML = '';
        document.getElementById('shopinfo').innerHTML = '';
      }

      // Li√™n k·∫øt Discord
      function linkDiscord() {
        let uid = localStorage.getItem('uid');
        window.location = '/link/discord?user_id=' + encodeURIComponent(uid);
      }

      // L·∫•y uid hi·ªán t·∫°i
      function getUID() {
        return localStorage.getItem('uid');
      }

      // Hi·ªán th√¥ng tin user
      function getUserInfo() {
        let uid = getUID();
        let avatar = localStorage.getItem('avatar');
        let username = localStorage.getItem('username');
        if (!uid) return;
        fetch('/api/user/' + uid)
        .then(res => res.json())
        .then(user => {
          if(user.success){
            let html = "";
            if (avatar && username) {
              html += `<img src="${avatar}" width="50" style="border-radius:50%;vertical-align:middle"> <b>${username}</b> (Discord ID: ${uid})<br>`;
            }
            html += "<b>Th√¥ng tin t√†i kho·∫£n:</b><br>";
            html += "ƒêi·ªÉm: " + user.points + "<br>";
            html += "Smart: " + user.smart + "<br>";
            html += "Items: ";
            if (Object.keys(user.items).length > 0) {
              html += "<ul>";
              for(let key in user.items) {
                html += "<li>" + key + ": " + user.items[key] + "</li>";
              }
              html += "</ul>";
            } else {
              html += " (Tr·ªëng)";
            }
            document.getElementById("userinfo").innerHTML = html;
          }
        });
      }

      // ========== C√ÅC H√ÄM CH·ª®C NƒÇNG ==========

      function daily() {
        let uid = getUID();
        fetch('/api/daily', {
          method: 'POST',
          body: JSON.stringify({ user_id: uid }),
          headers: { 'Content-Type': 'application/json' }
        })
          .then(res => res.json())
          .then(data => {
            document.getElementById("content-box").innerHTML = `<div>${data.msg}</div>`;
            if (data.success) getUserInfo();
          });
      }

      function getShop() {
        let uid = getUID();
        fetch('/api/user/' + uid)
          .then(res => res.json())
          .then(user => {
            if (!user.success) return;
            let userItems = user.items || {};
            fetch('/api/shop')
              .then(res => res.json())
              .then(data => {
                let html = "<ul>";
                for (let id in data.shop) {
                  let sp = data.shop[id];
                  let own = userItems[sp.name] || 0;
                  html += `<li>
                    ${sp.name} - Gi√°: ${sp.price} 
                    <button onclick="buyItem('${id}')">Mua</button>
                    ${own > 0 ? `
                      <button onclick="sellItemPrompt('${id}', '${sp.name}', ${own})">B√°n</button>
                      (B·∫°n c√≥: ${own})
                    ` : ""}
                  </li>`;
                }
                html += "</ul>";
                document.getElementById("content-box").innerHTML = html;
              });
          });
      }

      function buyItem(id) {
        let uid = getUID();
        let sl = prompt("Nh·∫≠p s·ªë l∆∞·ª£ng mu·ªën mua:", 1);
        if (!sl || isNaN(sl) || Number(sl) < 1) return;
        fetch('/api/buy', {
          method: 'POST',
          body: JSON.stringify({ user_id: uid, item_id: id, quantity: Number(sl) }),
          headers: { 'Content-Type': 'application/json' }
        })
        .then(res => res.json())
        .then(data => {
          alert(data.msg);
          getUserInfo();
          getShop();
        });
      }

      function sellItemPrompt(item_id, item_name, maxQty) {
        let uid = getUID();
        let sl = prompt(`Nh·∫≠p s·ªë l∆∞·ª£ng mu·ªën b√°n (B·∫°n c√≥: ${maxQty}):`, 1);
        if (!sl || isNaN(sl) || Number(sl) < 1) return;
        if (Number(sl) > maxQty) return alert("B·∫°n kh√¥ng c√≥ ƒë·ªß v·∫≠t ph·∫©m ƒë·ªÉ b√°n!");
        fetch('/api/sell', {
          method: 'POST',
          body: JSON.stringify({ user_id: uid, item_id: item_id, quantity: Number(sl) }),
          headers: { 'Content-Type': 'application/json' }
        })
        .then(res => res.json())
        .then(data => {
          alert(data.msg);
          getUserInfo();
          getShop();
        });
      }

      function showJar() {
        fetch('/api/jar')
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              document.getElementById("content-box").innerHTML =
                `<p style="font-size:20px; color:#c88c0c;">üí∞ Jackpot hi·ªán t·∫°i: <b>${data.jackpot_fmt} coin</b></p>`;
            }
          });
      }

      function showCCCD() {
        let uid = getUID();
        let avatar = localStorage.getItem('avatar');
        let username = localStorage.getItem('username');
        let url = '/api/cccd/' + uid +
          '?avatar=' + encodeURIComponent(avatar) +
          '&username=' + encodeURIComponent(username) +
          '&rand=' + Math.random();
        document.getElementById("content-box").innerHTML =
          `<img id="cccdimg" width="400" style="margin:22px auto 10px auto; display:block;" src="${url}">`;
      }

      function showLeaderboard() {
        fetch('/api/leaderboard/a')
          .then(res => res.json())
          .then(data => {
            let html = "<ul>";
            for (let u of data.leaderboard) {
              html += `<li>User: ${u.user_id} ‚Äì ƒêi·ªÉm: ${u.value}</li>`;
            }
            html += "</ul>";
            document.getElementById("content-box").innerHTML = html;
          });
      }

      function study() {
        let uid = getUID();
        fetch('/api/study', {
          method: 'POST',
          body: JSON.stringify({ user_id: uid }),
          headers: { 'Content-Type': 'application/json' }
        })
        .then(res => res.json())
        .then(data => {
          alert(data.msg);
          getUserInfo();
        });
      }

      function showTaixiu() {
        document.getElementById("content-box").innerHTML = `
          <div id="taixiu-box">
            <input type="number" id="ou_bet" placeholder="S·ªë ti·ªÅn c∆∞·ª£c" style="margin-bottom: 12px; width: 160px;"><br>
            <button onclick="playOu('t')">T√†i</button>
            <button onclick="playOu('x')">X·ªâu</button>
            <div id="ouresult" style="margin-top:14px;"></div>
          </div>
        `;
      }
      function playOu(choice) {
        let uid = getUID();
        let bet = document.getElementById("ou_bet").value;
        if (!bet) return alert("B·∫°n c·∫ßn nh·∫≠p s·ªë ti·ªÅn c∆∞·ª£c!");
        fetch('/api/ou', {
          method: 'POST',
          body: JSON.stringify({ user_id: uid, bet: bet, choice: choice }),
          headers: { 'Content-Type': 'application/json' }
        })
        .then(res => res.json())
        .then(data => {
          let resBox = document.getElementById("ouresult");
          if (!data.success) {
            resBox.innerText = data.msg;
          } else {
            resBox.innerHTML = `<b>${data.win ? "üéâ Th·∫Øng!" : "üíÄ Thua!"}</b><br>
              K·∫øt qu·∫£: ${data.dice[0]}, ${data.dice[1]}, ${data.dice[2]} (T·ªïng: ${data.total})<br>
              ${data.msg}`;
            getUserInfo();
          }
        });
      }

      function showHunt() {
        document.getElementById("content-box").innerHTML = `
          <div id="hunt-box">
            <h3>ƒêi sƒÉn</h3>
            <select id="hunt_weapon">
              <option value="g">S√∫ng sƒÉn</option>
              <option value="a">Awm</option>
              <option value="r">RPG</option>
              <option value="c">M√°y h√∫t b·ª•i</option>
            </select>
            <button onclick="hunt()">SƒÉn</button>
            <div id="huntresult" style="margin-top:10px;"></div>
          </div>
        `;
      }
      function hunt() {
        let uid = getUID();
        let weapon = document.getElementById("hunt_weapon").value;
        fetch('/api/hunt', {
          method: 'POST',
          body: JSON.stringify({ user_id: uid, weapon: weapon }),
          headers: { 'Content-Type': 'application/json' }
        })
        .then(res => res.json())
        .then(data => {
          let box = document.getElementById("huntresult");
          box.innerText = data.msg;
          getUserInfo();
        });
      }
    </script>
  </div>
  <div id="chat-tab" class="tab-content" style="display:none;">
      <div id="chat-window" style="height:240px;overflow-y:auto;background:#f8fafc;padding:12px;border-radius:6px;margin-bottom:10px;">
        <!-- Tin nh·∫Øn s·∫Ω hi·ªán ·ªü ƒë√¢y -->
      </div>
      <div style="display:flex;">
        <input id="chat-input" type="text" placeholder="Nh·∫≠p tin nh·∫Øn..." style="flex:1;padding:7px;border-radius:6px;border:1px solid #ccd9ea;">
        <button onclick="sendChat()" style="margin-left:8px;">G·ª≠i</button>
      </div>
  </div>
</body>
</html>
